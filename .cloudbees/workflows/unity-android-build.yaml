apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Unity Android Build

on:
  push:
    branches:
      - "main"

jobs:
  build-unity-apk:
    steps:
      - name: Checkout repository
        uses: cloudbees-io/checkout@v1
        
      - name: Activate Unity license (Unity Personal)
        uses: docker://unityci/editor:6000.0.49f1-android-3
        shell: sh
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ""  # empty for Unity Personal
        run: |
          unity-editor \
            -batchmode -nographics -quit \
            -username "$UNITY_EMAIL" \
            -password "$UNITY_PASSWORD" \
            -serial "$UNITY_SERIAL" \
            -logFile /dev/stdout

      - name: Build Android APK
        uses: docker://unityci/editor:6000.0.49f1-android-3
        shell: sh
        run: |
          mkdir -p Builds/Android
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -projectPath . \
            -executeMethod BuildScript.Build \
            -logFile build.log || (cat build.log && exit 1)

      - name: Return Unity license (optional)
        uses: docker://unityci/editor:6000.0.49f1-android-3
        shell: sh
        run: |
          unity-editor -batchmode -nographics -quit -returnlicense || true
